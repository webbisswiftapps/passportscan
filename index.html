<html>
<head>
<title> Passport Reader</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<style>

    #processing, #error, #success, #results{
        display:none;
    }


    .fileContainer {
    overflow: hidden;
    position: relative;
}

.fileContainer [type=file] {
    cursor: inherit;
    display: block;
    font-size: 999px;
    filter: alpha(opacity=0);
    min-height: 100%;
    min-width: 100%;
    opacity: 0;
    position: absolute;
    right: 0;
    text-align: right;
    top: 0;
}

/* Example stylistic flourishes */

.fileContainer {
    background: #2532a0;
    border-radius: .5em;
    float: left;
    padding: .5em;
    color:#ffffff;
}

.fileContainer [type=file] {
    cursor: pointer;
}



</style>
</head>
<body>

    <div class="w3-container w3-blue">
        <h1>Passport Reader</h1>
        <p>Proof of Concept</p>
    </div>


    <div class="w3-row-padding w3-theme">


    <div class="w3-third w3-section w3-cell">
        <div class="w3-card-4">
        <!--<canvas id="canvas" style="width:100%; background:#000000;"></canvas> -->
        <video id="video" autoplay></video>
        <div class="w3-container w3-white">
        <h4>Passport Image</h4>

            <p>
                 <label class="fileContainer">
                    Open Camera/Gallery
                    <!--<input id="filesnap" class="w3-bar-item w3-button w3-black inputfile" type="file" name="pfile" accept="image/*" >-->
                </label> <br/><br/>
            </p>

        <p id="waiting"><span><i class="w3-large fa fa-paperclip"></i> Waiting for image to process...</span></p>
        <p id="processing"><span><i class="w3-large w3-spin fa fa-refresh"></i> Processing...</span></p>
        <p id="error"><span><i class="w3-large fa fa-close"></i> Oops... Could not process this image.</span></p>
        <p id="success"><span><i class="w3-large fa fa-check-circle"></i> Done!</span></p>
        

        <p id="results"><table class="w3-table w3-striped">
            <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Points</th>
            </tr>
            <tr>
            <td>Jill</td>
            <td>Smith</td>
            <td>50</td>
            </tr>
            <tr>
            <td>Eve</td>
            <td>Jackson</td>
            <td>94</td>
            </tr>
            <tr>
            <td>Adam</td>
            <td>Johnson</td>
            <td>67</td>
            </tr>
        </table>
        </p>
        </div>
        </div>
    </div>



</div>


    <script>
                // Grab elements, create settings, etc.
        var video = document.getElementById('video');
        const constraints = {
            video: {width: {min: 640}, height: {min: 480}}
            
        }

        // Get access to the camera!
        if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            // Not adding `{ audio: true }` since we only want video now
            navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
                //video.src = window.URL.createObjectURL(stream);
                video.srcObject = stream;
                video.play();
            });
        }

                // Elements for taking the snapshot
        //var canvas = document.getElementById('canvas');
        //var context = canvas.getContext('2d');
        var video = document.getElementById('video');
        const api_url = "https://accurascan.com/v2/api";
        

        //Trigger image from file
        /*document.getElementById("filesnap").addEventListener("change", function(e){
            console.log("File Selected!!");
            console.log(e.target.files[0]);

            var file = e.target.files[0];
            var fr = new FileReader();

            if(file != undefined && fr != undefined){
                fr.onload = createImageFromFile;
                fr.readAsDataURL(file);
            }else console.log("Either file is empty or filereader is not supported by this browser.")
        });*/

        // Process Image
        function processImage()
        {
              
            var convertedImage = Image();

            const api_url = "/passscan/api.php";
            const data = { card_type:1, scan_image_base64: convertedImg};

            $("#waiting").hide();
            $("#results").hide();
            $("#error").hide();
            $("#success").hide();
            $("#processing").show();
            

            $.ajax({
                url: api_url,
                type: 'POST',
                data: data,
                dataType: 'json',
                success: function (data) {
                    console.info(data);
                    
                    $("#waiting").hide();
                    $("#processing").hide();

                    if(data.status){
                        $("#error").hide();
                        $("#results").show();
                        $("#success").show();
                        $("#success").text('Success! Found: '+data.message);
                    }else{
                        $("#error").show();
                        $("#results").hide();
                        $("#success").hide();
                        $("#error").text('Failed! Error: '+data.message);
                    }
                }
            });
        }
        


        //converts file url to an image and draws it to the canvas
        function createImageFromFile(fr){
            var img = new Image();
            img.onload = imageLoadedFromFile;
            img.src = fr.result;

            console.log(img);
        }

        function imageLoadedFromFile(img){
            context.drawImage(img, 0, 0, canvas.width, canvas.height);
        }

        function hasGetUserMedia() {
            return !!(navigator.mediaDevices &&
                navigator.mediaDevices.getUserMedia);
        }


        $(document).ready(function(){
                if(hasGetUserMedia()) {
                    // Good to go!\
                    alert("getUserMedia() is supported!! Woohoo!")
                } else {
                    alert('getUserMedia() is not supported by your browser');
                }
        });
    
    </script>
</body>
</html> 
